machine:
  ruby:
    version:
      2.0.0-p645

dependencies:
  post:
    - wget https://saucelabs.com/downloads/sc-4.3.13-linux.tar.gz
    - tar -xzf sc-4.3.13-linux.tar.gz
    - mv ./sc-4.3.13-linux $HOME/sc-bin

database:
  override:
    - bundle exec rake parallel:create
    - bundle exec rake parallel:prepare

test:
  override:
    - DISABLE_SPRING=1 bundle exec rspec --format RspecJunitFormatter --out $CIRCLE_TEST_REPORTS/specs/results$TEST_ENV_NUMBER.xml --tag ~data_heavy:
        parallel: true
        files:
          - spec/controllers/**/*_spec.rb
          - spec/models/**/*_spec.rb
          - spec/views/**/*_spec.rb
          - spec/mailers/**/*_spec.rb
          - spec/jobs/**/*_spec.rb
          - spec/lib/**/*_spec.rb
          - spec/helpers/**/*_spec.rb
          - spec/requests/**/*_spec.rb
    - sleep 2:
        parallel: true
    - $HOME/sc-bin/bin/sc --user $SAUCE_USERNAME --api-key $SAUCE_ACCESS_KEY --readyfile ~/hot-sauce:
        background: true
        parallel: true
    - while [ ! -e ~/hot-sauce ]; do sleep 1; done:
        parallel: true
    #- USE_SAUCE='ie9' bin/parallel_features:
    #    parallel: true
    #    files:
    #      - spec/features/customer_admin/campaigns/*
    #- sleep 2:
    #    parallel: true
    #- USE_SAUCE='ie10' bin/parallel_features:
    #    parallel: true
    #    files:
    #      - spec/features/customer_admin/campaigns/*
    #- sleep 2:
    #    parallel: true
    - USE_SAUCE='ie11' bin/parallel_features:
        parallel: true
        files:
          - spec/features/customer_admin/campaigns/*
    - USE_SAUCE='wch' bin/parallel_features:
        parallel: true
        files:
          - spec/features/customer_admin/campaigns/*
  post:
    - killall --wait sc  # wait for Sauce Connect to close the tunnel

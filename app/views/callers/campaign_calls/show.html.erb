<% content_for :stylesheets do %>
  <link rel="stylesheet" type="text/css" media="screen" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.14/themes/smoothness/jquery-ui.css"/>
  <%= stylesheet_link_tag 'jquery.ui.datetime' %>
<% end %>

<% content_for :javascripts do %>
  <%= javascript_include_tag("https://d3dy5gmtp8yhk7.cloudfront.net/2.1/pusher.min.js") %>
  <%= javascript_include_tag("https://static.twilio.com/libs/twiliojs/1.1/twilio.min.js") %>
  <%= javascript_include_tag(:caller_ui) %>

  <script type="text/javascript">
    var warning='';
    var client_ready=false;

    function flash_supported(){
      return (FlashDetect.major>10 || (FlashDetect.majorAtLeast(10) && FlashDetect.minorAtLeast(1)));
    }

    function browser_supported(){
      //Google Chrome 11+, Internet Explorer 7+, Safari 5+, and Firefox 3.6+
      var supported=false;
      if (BrowserDetect.browser=="Chrome" && BrowserDetect.version>=11)
        supported=true;
      if (BrowserDetect.browser=="Explorer" && BrowserDetect.version>=7)
        supported=true;
      if (BrowserDetect.browser=="Safari" && BrowserDetect.version>=5)
        supported=true;
      if (BrowserDetect.browser=="Firefox" && BrowserDetect.version>=3.6)
        supported=true;
      if (isNativeApp())
        supported=true;

      return supported;
    }

    if (!FlashDetect.installed){
      if(!isNativeApp()){
        warning='<%=  t('flash_missing_html') %>';
      }
    }

    if (!flash_supported()){
      if(!isNativeApp()){
        warning = '<%=  t('flash_old_html') %>';
      }
    }

    if (!browser_supported()){
      warning = "<%=  t('browser_unsupported').html_safe %>";
    }

    if (warning != ''){
      $('#flash-error-info-container').show();
      $('#flash-error-info').html(warning);
    }
  </script>
<% end %>

<% content_for :javascripts do %>
  <script type="text/javascript">
    $(window).bind("beforeunload", function(){
      if( $("#caller_session").val() ){
        $.ajax({
          url : "/caller/" + $("#caller").val() + "/stop_calling",
          data : {session_id : $("#caller_session").val() },
          type : "POST",
          async : false,
          success : function(response) {
            $("#start_calling").show();
          }
        });
      }
    });
  </script>
<% end %>

<% content_for :javascripts do %>
  <script type="text/javascript">
    $(function(){
      if( window.domLoaded === undefined ){
        window.domLoaded = new Date().getTime();
      }
    });

    ImpactDialing.Debugger = new ImpactDialing.Utilities.Debugger({
      afterDataAdd: function(data) {
        _errs.meta = data;
      }
    });

    _errs.meta = {};

    var _usersnapconfig = {
      apiKey: 'ee7280e5-4afa-4854-87a6-b19d6c1cf460',
      beforeSend: function(obj) {
        obj.addInfo = ImpactDialing.Debugger.debugData;
      },
      errorHandler: function(message, code) {
        var d = {},
            k = 'usersnap-error-' + code.toString();
        d[k] = message
        ImpactDialing.Debugger.addData(d);
      }
    };

    (function() {
      var s = document.createElement("script");
      s.type = "text/javascript";
      s.async = true;
      s.src = '//api.usersnap.com/beta/'+
             'ee7280e5-4afa-4854-87a6-b19d6c1cf460.js';
      var x = document.getElementsByTagName('head')[0];
      x.appendChild(s);
    })();
  </script>

  <script type="text/javascript">
    addCallerInfo = function(caller_info){
      ImpactDialing.Debugger.addData({
        caller_id: caller_info.get('caller_id'),
        caller_session_key: caller_info.get('caller_session_key'),
        campaign_id: caller_info.get('campaign_id'),
        phone_number: caller_info.get('phone_number'),
        account_id: caller_info.get('account_id')
      });
    };

    addLeadInfo = function(lead_info, options){
      ImpactDialing.Debugger.addData({
        lead_info: lead_info.toJSON()
      });
    };

    $(function() {
      new ImpactDialing.Services.NetworkConnectionMonitor({
        afterStatsUpdate: ImpactDialing.Debugger.addData
      });

      window.campaign_call = new ImpactDialing.Models.CampaignCall();
      campaign_call.set({pusher_key: '<%= Pusher.key %>'});
      window.campaign_call_view = new ImpactDialing.Views.CampaignCall({
        model: campaign_call,
        pusherConnectionMonitor: ImpactDialing.Services.PusherConnectionMonitor,
        pusherMonitorAfterStatsUpdate: ImpactDialing.Debugger.addData,
        twilioConnectionMonitor: ImpactDialing.Services.TwilioConnectionMonitor,
        twilioMonitorAfterStatsUpdate: ImpactDialing.Debugger.addData
      });

      campaign_call_view.bind('rendered.caller.info', addCallerInfo);

      campaign_call_view.lead_info.on('change', addLeadInfo);

      campaign_call_view.render();
    });
  </script>
<% end %>

<div class="callout alert clearfix" id="flash-error-info-container" style="display:none">
  <p id="flash-error-info"></p>
</div>

<noscript>
  <div class="callout alert clearfix">
    <p><%= t('javascript_disabled') %></p>
  </div>
</noscript>

<div id="caller-alert">
  <p><strong></strong></p>
</div>

<div id="container" >
  <form class="sticky sticky-voter-info">
    <fieldset>
      <legend>Lead information</legend>
      <div id="voter_info_message" class="rt">
        <em>When connected, lead information will appear here.</em>
      </div>
      <ul id="voter_info" class="clearfix">
      </ul>
    </fieldset>
  </form>
</div>

<script type="javascript/html" id="caller-campaign-script-lead-info-template">
  {{#fields}}
    {{#ID_flag}}
      <li>ID: <b>{{custom_id}}</b></li>
    {{/ID_flag}}
    {{#FirstName_flag}}
      <li>First name: <b>{{first_name}}</b></li>
    {{/FirstName_flag}}
    {{#MiddleName_flag}}
      <li>Middle name: <b>{{middle_name}}</b></li>
    {{/MiddleName_flag}}
    {{#LastName_flag}}
      <li>Last name: <b>{{last_name}}</b></li>
    {{/LastName_flag}}
    {{#Suffix_flag}}
      <li>Suffix: <b>{{suffix}}</b></li>
    {{/Suffix_flag}}
    {{#Address_flag}}
      <li>Address: <b>{{address}}</b></li>
    {{/Address_flag}}
    {{#City_flag}}
      <li>City: <b>{{city}}</b></li>
    {{/City_flag}}
    {{#State/Province_flag}}
      <li>State/Province: <b>{{state}}</b></li>
    {{/State/Province_flag}}
    {{#Zip/Postal Code_flag}}
      <li>Zip/Postal Code: <b>{{zip_code}}</b></li>
    {{/Zip/Postal Code_flag}}
    {{#Country_flag}}
      <li>Country: <b>{{country}}</b></li>
    {{/Country_flag}}
    {{#Phone_flag}}
      <li>Phone: <b>{{phone}}</b></li>
    {{/Phone_flag}}
    {{#Email_flag}}
      <li>Email: <b>{{email}}</b></li>
    {{/Email_flag}}
  {{/fields}}
  {{#custom_lead_info}}
    <li>{{key}}: <b>{{value}}</b></li>
  {{/custom_lead_info}}
</script>

<form id="voter_responses" method="post" ></form>

<script type="javascript/text" id="caller-campaign-script-text-template">
  <fieldset class="script_element">
    {{{ content }}}
  </fieldset>
</script>

<script type="javascript/html" id="caller-campaign-script-question-template">
  <fieldset class="script_element">
    <p>
      <label>{{text}}</label><br/>
      <select id="question_{{id}}" name="question[{{id}}]">
        {{#possible_responses}}
          <option value="{{id}}">{{value}}</option>
        {{/possible_responses}}
      </select>
    </p>
  </fieldset>
</script>

<script type="javascript/html" id="caller-campaign-script-notes-template">
  <fieldset class="script_element">
    <p><label>{{note}}</label><br/>
      <input type="text" id="note_response_{{id}}" name="notes[{{id}}]" class="note_text"/>
    </p>
  </fieldset>
</script>

<script type="javascript/html" id="caller-campaign-script-transfer-template">
  <fieldset id="transfer-calls">
    <legend>Transfer</legend>
    <form id="transfer_form" method="post" action="/transfer/dial">
      <input type="hidden" id="transfer_type" name="transfer_type" >
      <select id="transfer_id" name="transfer[id]">
        {{#transfers}}
        <option value="{{id}}">{{label}}-{{phone_number}}</option>
        {{/transfers}}
      </select>
      <div class= "buttons">
        <button type="submit" id="transfer_button" style="margin-top:10px">Transfer</button>
      </div>
    </form>
    <p id="transfer_status"></p>
  </fieldset>
</script>

<div id="schedule_callback" class="rt" style="font-size : 1em; display:none"></div>

<script type="javascript/html" id="caller-campaign-schedule-callback-template">
  <%= render :partial => "schedule_callback" %>
</script>

<div id="caller-actions"></div>

<script type="javascript/html" id="caller-campaign-action-template">
  <div id="actions" class="actions">
    <a id="call_voter" href="#caller-campaign-action-template" class="action secondary caller-action-buttons hide">Dial</a>
    <a id="skip_voter" href="#caller-campaign-action-template" class="action secondary caller-action-buttons hide">Skip</a>
    <a id="stop_calling" href="#caller-campaign-action-template" class="action secondary caller-action-buttons hide">Stop calling</a>
    <a id="hangup_call" href="#caller-campaign-action-template" class="action secondary caller-action-buttons hide">Hang up</a>
    <a id="kick_caller" href="#caller-campaign-action-template"  class="action secondary caller-action-buttons hide">Hang up</a>
    <a id="kick_transfer" href="#caller-campaign-action-template"  class="action secondary caller-action-buttons hide">Hang up transfer</a>
    <a id="submit_and_keep_call" href="#caller-campaign-action-template" class="action secondary caller-action-buttons hide">Submit and keep calling</a>
    <a id="submit_and_stop_call" href="#caller-campaign-action-template" class="action secondary caller-action-buttons hide" >Submit and stop calling</a>
  </div>
  <div id="statusdiv" style="float:right">Status: Not connected.</div>
</script>

<script type="javascript/html" id="caller-campaign-start-calling-template">
  <div id="callin" style="display:none">
    <div id="start_calling" >
      <p class="webapp-callin-info"><b>If your computer has a mic, click here:</b></p>
        <a class="action primary" href="#" id="start-calling">Start calling</a>
        <a class="action primary" href="#" id="start-calling-mobile" class="hide" style="display:none">Start calling</a>
      </div>
    <br>

    <div id="callin_data" class="webapp-callin-info">
      <p>
        <b>If you don't have a mic, use a phone:</b><br>
        Dial-in number: <span id="callin-number"></span><br>
        PIN: <span id="callin-pin"></span>
      </p>
    </div>
 </div>
</script>

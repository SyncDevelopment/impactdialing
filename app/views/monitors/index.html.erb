<script type="text/javascript" src="https://static.twilio.com/libs/twiliojs/1.0/twilio.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.js"></script>
<script src="https://d3ds63zw57jt09.cloudfront.net/1.9/pusher.min.js" type="text/javascript" ></script>
<%= javascript_include_tag 'monitors/monitor_pusher', 'ICanHaz.min.js' %>

  <script type="text/javascript">
      var pusher = new Pusher('<%= Pusher.key %>');
  </script>

<script type="text/javascript">

  Twilio.Device.setup("<%= @token %>", {'debug':true});

  Twilio.Device.connect(function (conn) {
    console.log("Successfully established call");
  });
  Twilio.Device.ready(function (device) {})
  Twilio.Device.error(function (error) {
    alert(error.message);
  });
  
  
  function de_activate_monitor(){
    $.ajax({
        url : "/client/monitors/stop",
        data : {monitor_session : $('monitor_session').text()},
        type : "GET",
        async : false,
        success : function(response) {}
      });
  }
  
  $(window).bind("beforeunload", function(){
      de_activate_monitor();
    })

  function monitor(session_id, action, status){
    params = {'session_id': session_id, 'type': action, monitor_session : $('monitor_session').text()};
    $('status').text(status)
    $('.stop_monitor').show();
    Twilio.Device.connect(params)
  }
  function stop_monitoring(){
    $('status').text("You are monitoring nothing")
    $('.stop_monitor').hide();
    $.each($('tr.caller'), function(){
      $(this).removeAttr("on_call");
    });
    Twilio.Device.disconnectAll();
    return false;
  }
  
  function switch_mode(session, mode){
    $.ajax({
        url : "/client/monitors/switch_mode",
        data : {session_id : session,type : mode},
        type : "GET",
        success : function(response) {
          $('status').text(response)
          }
    })
  }

  $(function() {
    $('.monitor').live('click', function(){
      if($(this).parent().parent().attr("on_call")){
        switch_mode($(this).attr("session_id"), $(this).attr("action"));
      }
      else{
        $.each($(this).parent().parent().siblings(), function(){
          if($(this).attr("on_call")){
            stop_monitoring();
            $(this).removeAttr("on_call");
          }
        });

        status = "Your currently "+$(this).attr("action") + " on "+$(this).parent().prevAll('td.caller_name').text().split("/").first();
        monitor($(this).attr("session_id"), $(this).attr("action"), status);
        $(this).parent().parent().attr("on_call","true")
      }
      return false;
    })

  });

</script>

<script id="caller" type="text/html">
  <tr id={{id}} class="caller <%= cycle("odd", "even") %> ">
      <td class="caller_name">{{email}}</td>
      <td>{{campaign_name}}</td>
      <td class="voter_phone"></td>
      <td>
        <a class ="action secondary monitor" href="#" action="eavesdrop" session_id={{session_id}}>Eavesdrop</a>
      </td>
      <td>
        <a class ="action secondary monitor" href="#" action="breakin" session_id={{session_id}}>Break In</a>
      </td>
  </tr>
</script>
<script id="campaign" type="text/html">
  {{#campaign_fields}}
    <tr id={{id}} class="campaign <%= cycle("odd", "even") %>">
       <td><h3><a href={{path}} >{{campaign_name}}</a></h3></td> 
       <td class="callers_logged_in">{{callers_logged_in}}</td>
       <td class="voters_count">{{voters_count}}</td>
    </tr>
  {{/campaign_fields}}

</script>


<h1>Monitor</h1>
<monitor_session style="display:none"></monitor_session>
  <h2>Campaigns</h2>
      <div class="table">
        <table id="campaign_table" width="100%" border="0" cellspacing="0" cellpadding="0">
          <tr class="table_header">
            <th>Name</th>
            <th>Callers logged in</th>
            <th>Numbers remaining</th>
          </tr>
          <% if @campaigns.present? %>
          <% @campaigns.each do |c| %>
              <tr id="<%= c.id %>" class="campaign <%= cycle("odd", "even") %>">
                <td><h3><%= link_to c.name, campaign_path(c) %></h3></td>
                <td class="callers_logged_in"><%= c.caller_sessions.on_call.length %></td>
                <td class="voters_count"><%= c.voters_count("not called", false).length %></td>
              </tr>
          <% end %>
          <% end %>
        </table>
      </div>
  <% #end %>

<br>

<h2>Callers</h2>
<% #if @campaigns.length > 0 %>
    <div class="box">  
      <div class="table">
        <table id="caller_table" width="100%" border="0" cellspacing="0" cellpadding="0">
          <tr class="table_header">
            <th>Caller</th>
            <th>Campaign</th>
            <th></th>
            <th></th>
          </tr>
          <% @campaigns.each do |c| %>
              <% c.caller_sessions.on_call.each do |caller_session| %>
                  <tr id="<%= caller_session.caller.id %>" class="caller <%= cycle("odd", "even") %> ">
                    <td class="caller_name"><%= caller_session.caller.email %></td>
                    <td><%= caller_session.campaign.name %></td>
                    <td>
                      <a class ="action secondary monitor" href="#" action="eavesdrop" session_id="<%= caller_session.id %>">Eavesdrop</a>
                    </td>
                    <td>
                      <a class ="action secondary monitor" href="#" action="breakin" session_id="<%= caller_session.id %>">Break in</a>
                    </td>
                  </tr>
              <% end %>
          <% end %>
        </table>
        <a class ="action primary stop_monitor" href="#" onclick="javascript:stop_monitoring();">Stop monitoring</a>
        <status style="float : right;"></status>
      </div>
    </div>
<% #end %>

<br>

<h2>System-wide settings</h2>
<%= link_to "Manage Do Not Call list", blocked_numbers_path, :class => 'action secondary' %>
<%= link_to "Call Recording: #{@call_recordings_enabled}", {:action=>"toggle_call_recording"}, {:class => 'action secondary'} %>

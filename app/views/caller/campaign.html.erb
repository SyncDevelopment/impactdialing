<% content_for :stylesheets do %>
    <link rel="stylesheet" type="text/css" media="screen" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.14/themes/smoothness/jquery-ui.css" />
    <%= stylesheet_link_tag 'jquery.ui.datetime' %>
<% end %>
<% content_for :javascripts do %>
    <%= javascript_include_tag 'jquery.ui.datetime.min' %>
<% end %>

<% form_tag("/caller/campaign/#{params[:id]}", {:class => "form", :id=>"myform", :name=>"myform"}) do %>
    <h3><%= @campaign.name %></h3>
    <fieldset>
      <legend>Lead information</legend>
      <div id="previewInfo" style="display:none;" class="rt">
        <div id="previewvoterInfo"></div>
      </div>
      <div id="voter_info" class="rt">
        <em>When connected, lead information will appear here.</em>
      </div>
    </fieldset>

    <fieldset>
      <legend>Script</legend>
      <% if !@campaign.script.script.blank? %>
          <div class="rt script"> <%= @campaign.script.script.gsub("\n", "<br/>") %></div>
      <% end %>
    </fieldset>

    <fieldset>
      <legend>Results</legend>
      <div id="result_instruction"><em>When connected, call result options will appear here.</em></div>
      <div id="response" class="rt" style="display:none; font-size:1em;">
        <% @script.result_sets_used.each do |r| %>
            <% json = JSON.parse(eval("@script.result_set_#{r}")) %>
            <% if !json["name"].blank? %>
                <div><%= json["name"] %></div>
            <% end %>
            <select class="field" id="disposition<%= r %>" style="display:inline;">
              <% for b in 1..99 do %>
                  <% thisKeypadval=json["keypad_#{b}"] %>
                  <% if !thisKeypadval.blank? %><option value="<%= b %>"><%= thisKeypadval %></option>
                  <% end %>
              <% end %>
            </select>
        <% end %>
        <% @campaign.script.notes_used.each do |b| %>
            <% thisNote=eval("@script.note_#{b}") %>
            <div style="margin:3px;padding:3px;"><%= thisNote %>
              <input type="text" name="note<%= b %>" id="note<%= b %>" size="30"></div>
        <% end %>
        <div id="callback_scheduler" style="display: none;">
          <p><%= link_to_function 'Schedule callback', 'expand_scheduler()', :class=> "action secondary" %></p>

          <div id="callback_info" style="display: none;">
            <div>
              <p>
                Date and time to call back:
                <input id="scheduled_date"/>
                <input type="hidden" id="current_call_attempt_id" value="0">
              </p>
            </div>
            <div style="clear: both;">
              <%= link_to_function 'Schedule', 'set_schedule()', :class=> "action secondary" %>
              <%= link_to_function 'Hide', 'collapse_scheduler()', :class=> "action secondary" %>
            </div>
          </div>

        </div>
      </div>
    </fieldset>

    <div class="caller_buttons" id="caller_buttons">
      <div id="statusdiv" style="float:right; padding-bottom:10px;">Status: Not connected.</div>
      <div id="actiondiv">
        Enter your phone number:
		<input type="text" name="numtocall" id="numtocall" placeholder="Type your phone number here">
        <p>

        <div class="buttons">
          <button type="submit">Start taking calls</button>
        </div>
		<% if @session.blank? %>
		<p><input type="radio" name="client" value="0" checked onclick="$('#numtocall').show();"> Call my Phone</p>
		<p><input type="radio" name="client" value="1" onclick="$('#numtocall').hide('slide', { direction: 'up' }, 400);"> Use Browser Phone</p>
		<% end %>
        </p>
      </div>
    </div>
	<img src="/images/report_bug.png" onclick="feedback();">

    <% if !@session.blank? %>
        <script src="http://js.pusherapp.com/1.8/pusher.min.js" type="text/javascript"></script>
        <script type="text/javascript" src="/caller/jspush/<%= @session.session_key %>"></script>

		<% if params[:client]=="1" %>
		<script type="text/javascript" src="http://static.twilio.com/libs/twiliojs/1.0/twilio.js"></script> 
		<script>
		Twilio.Device.setup("<%= @token %>", {'debug':true});

		function goclient() {
			Twilio.Device.ready(function (device) {
				setTimeout("connection = Twilio.Device.connect(<%= @params %>)",1000);
			});


			Twilio.Device.error(function (error) {
	 			alert(error.message);
			});


		}
		</script>
		<% else %>	
			<script>
			function goclient() {}	
		</script>
		<% end %>
    <% end %>

<% end -%>
<!--<input type="button" value="poll" onclick="dpoll();">-->
<textarea id="dbx" rows="10" cols="90" style="overflow:auto; font-size:10px; display:none;"></textarea>

<script>
    function feedback() {
        var info = prompt("Please enter a description of the issue:", "");
        info = document.getElementById('dbx').value + '<p>' + info + "</p><p>" + BrowserDetect.browser + ' ' + BrowserDetect.version + ' ' + BrowserDetect.OS + ' ' + horizontal + 'x' + vertical + '</p>';
        var flash = '';
        for (var i in FlashDetect) {
            if (typeof FlashDetect[i] != "function" && typeof FlashDetect[i] != "undefined") {
                if (i == 'raw' || i == 'installed')
                    flash += "<p>FlashDetect." + i + ":" + FlashDetect[i] + "</p>";
            }
        }
        info = info + flash;
    <% if !@session.blank? %>
        info = info + '<p>session <%= @session.id %></p>';
    <% end %>
        info = info + '<p>caller <%= @caller.id %> <%= @caller.name %> <%= @caller.email %></p>';
        info = info + '<p>campaign <%= @campaign.id %> <%= @campaign.name %></p>';
        info = info + '<p>script <%= @script.id %> <%= @script.name %></p>';
        info = info + '<p>ip <%= @client_ip %></p>';

        $.post("/caller/feedback", { issue: info});
        alert('Thank you for sending your feedback.')
    }

    function show_scheduler() {
        $("#callback_scheduler").show();
    }

    function collapse_scheduler() {
        $("#callback_info").hide();
    }

    function expand_scheduler() {
        $("#callback_info").show();
    }

    function set_schedule() {
        $.post("<%= call_attempt_path(':call_attempt_id') %>".replace(':call_attempt_id', $('#current_call_attempt_id').val()),
                {_method: 'PUT', call_attempt : { scheduled_date : $('#scheduled_date').val()}},
                function(response) {
                    alert(response);
                }
        );
    }

    $(document).ready(function() {
        $('#scheduled_date').datetime({ inline: true });
    });


</script>

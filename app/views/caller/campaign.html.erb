<% form_tag("/caller/campaign/#{params[:id]}", {:class => "form", :id=>"myform", :name=>"myform"}) do %>
	<div class="box" style="width:100%;">
		<%= render :partial => 'client/boxtop', :locals=>{:title=>"#{@campaign.name}"} %>
		<div class="box-content">
			<div id="previewInfo" style="display:none;" class="rt">
				<div id="previewvoterInfo"></div>
			</div>
			<div id="voter_info" class="rt" style="display:none;">When connected, voter information will appear here</div>
			<br/>
			<% if !@campaign.script.script.blank? %><div class="rt"> <%= @campaign.script.script.gsub("\n", "<br/>") %></div><% end %>
			<br/>
			<div id="response" class="rt" style="display:none; font-size:1em;">
				<%# @script.name %>
				<% @script.result_sets_used.each do |r| %>
					<% json = JSON.parse(eval("@script.result_set_#{r}")) %>
					<select class="field" id="disposition<%= r %>" style="display:inline;">
						<%  for b in 1..99 do %>
							<% thisKeypadval=json["keypad_#{b}"] %>
							<% if !thisKeypadval.blank? %><option value="<%= b %>"><%= thisKeypadval %></option><% end %>
						<% end %>
					</select>
				<% end %>
				<% @campaign.script.notes_used.each do |b| %>
					<% thisNote=eval("@script.note_#{b}") %>
					<div style="margin:3px;padding:3px;"><%= thisNote %> <input type="text" name="note<%= b %>" id="note<%= b %>"  size="30"></div>
				<% end %>

			</div>
		</div>
		<div class="caller_buttons" id="caller_buttons">
			<div id="statusdiv" style="float:right; padding-bottom:10px;">Status: Not connected.</div>
	      	<div id="actiondiv">Enter your phone number: <input type="text" name="numtocall"> <input type="submit" class="button" value="Start Taking Calls">
			
		</div>
	
	    </div>
    
	</div>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.5/jquery-ui.min.js"></script>
	<script type="text/javascript" src="http://www.twiliort.com/v1/realtime-client.js"></script>
	<% if !@session.blank? %>
	<script type="text/javascript" src="/caller/js/<%= @session.session_key %>"></script>
	<% end %>
	<% if @on_call!=nil %>
		<script type="text/javascript" src="/caller/js/<%= @on_call.session_key %>?reconnect=1"></script>
		<%- 
			if @on_call.available_for_call? 
				k="waiting"
				if @campaign.predective_type=="preview"
					v="preview"
#        			send_rt (params[:key],{'waiting'=>'preview'})
      			else
					v="ok"
 #       			send_rt (params[:key],{'waiting'=>'ok'})
      			end
			else
				script = @campaign.script
				attempt = CallAttempt.find(@on_call.attempt_in_progress)
				family=[hash_from_voter_and_script(script,attempt.voter)]
		        attempt.voter.families.each do |f|
		        	family << hash_from_voter_and_script(script,f)
		        end
				k="voter_start"
        		publish_hash = {"attempt_id"=>attempt.id, "family"=>family}
        		if !script.voter_fields.nil?
          			fields = JSON.parse(script.voter_fields)
          			fields.each do |field|
            			publish_hash[field] = eval("attempt.voter.#{field}")
          			end
        		end
        		v=publish_hash.to_json
				
			end 
			-%>

		<script>
			$('#statusdiv').html("Status: Reconnecting");
						function rc(){
						var url = '/caller/reconnect_rt?key=<%= @on_call.session_key %>&k=<%=k%>&v=<%=v%>';
						$.ajax({
						    type: 'GET',
						    dataType: 'script',
						    url: url
						  });
						}
						setTimeout("rc()", 3000);

		</script>

	<% end %>
<% end -%>

<%# @session.session_key if @session!=nil %>
<textarea id="dbx" rows="10" cols="90" style="overflow:auto; font-size:10px; display:none;"></textarea>
<p><a href="#" onclick="$('#dbx').show();">&mdash;</a></p>

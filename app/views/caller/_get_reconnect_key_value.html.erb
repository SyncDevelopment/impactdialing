<%-
if @on_call.available_for_call? 
	@k="waiting"
	if @campaign.predective_type=="preview"
		@v="preview"
   else
		@v="ok"
	end
else
	script = @campaign.script
	@attempt = CallAttempt.find(@on_call.attempt_in_progress)
	family=[hash_from_voter_and_script(script,@attempt.voter)]
	@attempt.voter.families.each do |f|
		family << hash_from_voter_and_script(script,f)
	end
	@k="voter_start"
    publish_hash = {"attempt_id"=>@attempt.id, "family"=>family}
    if !script.voter_fields.nil?
    	fields = JSON.parse(script.voter_fields)
        fields.each do |field|
        	publish_hash[field] = @attempt.voter.get_attribute(field)
        end
    end
    @v=publish_hash.to_json
end 
%>